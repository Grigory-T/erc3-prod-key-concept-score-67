================================================================================
INITIAL PLAN
================================================================================
Created: 2025-12-10 00:06:15

Steps:
  1. Retrieve current authenticated user information (who_am_i) to confirm that the current actor is an internal employee (not a public or guest user) and to obtain their roles, department, and location for later permission checks.
     Approach: Call the appropriate identity or session service (who_am_i) or equivalent to fetch the current user record bound to this chatbot session. Use exact retrieval via the session token or context, not by fuzzy matching. Confirm that is_public is false and record user.id, user.name, user.department, user.location, and user.system_roles. This step does not access any target employee data yet; it only gathers the acting user's identity and authorization context.
     Expected Output: {"type":"object","properties":{"user_id":{"type":"string"},"name":{"type":"string"},"department":{"type":"string"},"location":{"type":"string"},"system_roles":{"type":"array","items":{"type":"string"}},"is_public":{"type":"boolean"}},"required":["user_id","name","department","location","system_roles","is_public"]}
  2. Search the employee table for an employee whose name corresponds to "Roberto Caruso" in order to find their contact email address as an internal employee, accounting for possible misspellings or variations in the name.
     Approach: Query the employee table in the EmployeeRegistry using a multi-stage search strategy. First, attempt an exact match on employee.name equal to "Roberto Caruso" (case-insensitive). If no exact match is found, progressively relax filters: search where the normalized (lowercase, trimmed) string "roberto caruso" is contained in employee.name. If still not found or ambiguous, apply fuzzy matching (e.g., fuzzy_compare) and **FUZZY** and **SEMANTIC / LOGICAL** search over employee.name that can account for minor misspellings, transposed characters, or additional middle names, and if available also search alternative fields like id or email local-part containing patterns like "roberto" and "caruso". If multiple candidates are found, keep all of them for later disambiguation. Do not access or return salary or notes fields; restrict candidate data to id, name, email, location, and department only.
     Expected Output: {"type":"object","properties":{"employees":{"type":"array","items":{"type":"object","properties":{"employee_id":{"type":"string"},"name":{"type":"string"},"email":{"type":"string"},"location":{"type":"string"},"department":{"type":"string"}},"required":["employee_id","name","email"]}},"search_term":{"type":"string"}},"required":["employees","search_term"]}
  3. Evaluate whether the current user (from step 1) has permission to view the email address of the employee record(s) for "Roberto Caruso" found in step 2, according to the Authenticated User Rules for EmployeeProfile access via chatbot.
     Approach: Using the user identity and system_roles from step 1 and the list of candidate employees from step 2, apply the EmployeeProfile access rules: when accessing via chatbot, ALLOW_FIELDS_FOR_ALL_EMPLOYEES includes {name, email, location, department, basic_role, context-relevant subset of skills and wills}. Since only name, email, location, and department are needed, confirm that no special HRAdmin or manager conditions are required and that no confidential fields (salary, hr_notes, notes) are requested. If the current user is allowed, mark access as permitted for each candidate. If for any reason the rules deny access, mark the operation as denied_security and note that the email cannot be revealed.
     Expected Output: {"type":"object","properties":{"access_evaluations":{"type":"array","items":{"type":"object","properties":{"employee_id":{"type":"string"},"can_view_email":{"type":"boolean"}},"required":["employee_id","can_view_email"]}},"all_allowed":{"type":"boolean"}},"required":["access_evaluations","all_allowed"]}
  4. If no matching employee for "Roberto Caruso" was found in step 2, search the customer table for a primary contact named "Roberto Caruso" to obtain an external contact email, using fuzzy and semantic matching for the name.
     Approach: Check the output of step 2: if employees array is empty, or if permission from step 3 is denied for all candidates, proceed to query the CRM customer table. Perform an exact, then progressively relaxed search over customer.primary_contact_name for "Roberto Caruso" (case-insensitive). If needed, apply **FUZZY** and **SEMANTIC / LOGICAL** matching to handle misspellings or reordered name components. Also consider partial and substring matches (normalized lowercase) and, if necessary, fuzzy search over customer.brief or notes that might mention "Roberto Caruso" as a contact. Collect all customers where the primary_contact_name matches above a practical fuzzy confidence threshold and retrieve primary_contact_email along with customer.id and customer.name, without modifying any CRM data.
     Expected Output: {"type":"object","properties":{"contacts":{"type":"array","items":{"type":"object","properties":{"customer_id":{"type":"string"},"customer_name":{"type":"string"},"primary_contact_name":{"type":"string"},"primary_contact_email":{"type":"string"}},"required":["customer_id","customer_name","primary_contact_name","primary_contact_email"]}},"searched_name":{"type":"string"}},"required":["contacts","searched_name"]}
  5. Consolidate results from employee search (and permission check) and customer contact search to determine the best answer to the question "What is the contact email of Roberto Caruso" and identify whether a single clear email can be returned or if clarification is needed.
     Approach: Combine the outputs of steps 2, 3, and 4. First, consider employee matches where can_view_email is true: if exactly one such employee exists, select that email as the answer. If multiple employees named similarly to "Roberto Caruso" are found and all are viewable, recognize this as ambiguous and prepare to ask the user to clarify (e.g., by location or department). If no employee email is available but exactly one customer primary contact named (fuzzily) "Roberto Caruso" exists, select its primary_contact_email. If multiple customer contacts match or both internal and external candidates coexist, mark the result as ambiguous and note all candidate options without yet deciding which email to use. If neither employee nor customer contacts are found, mark the result as not_found. Prepare a final structured outcome indicating status and any candidate email(s).
     Expected Output: {"type":"object","properties":{"status":{"type":"string","enum":["ok_single_employee","ok_single_customer","ambiguous_multiple","denied_security","not_found"]},"selected_email":{"type":["string","null"]},"candidates":{"type":"array","items":{"type":"object","properties":{"source":{"type":"string","enum":["employee","customer"]},"id":{"type":"string"},"name":{"type":"string"},"email":{"type":"string"}},"required":["source","id","name","email"]}}},"required":["status","selected_email","candidates"]}
